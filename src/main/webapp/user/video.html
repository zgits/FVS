<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>

    <!-- Bootstrap 3.3.7 -->
    <link rel="stylesheet" href="../static/bower_components/bootstrap/dist/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="../static/bower_components/font-awesome/css/font-awesome.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="../static/bower_components/Ionicons/css/ionicons.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="../static/dist/css/AdminLTE.min.css">

    <link rel="stylesheet" href="../static/plugins/sweetalert/sweetalert.css">
    <!-- AdminLTE Skins. Choose a skin from the css/skins
         folder instead of downloading all of them to reduce the load. -->
    <link rel="stylesheet" href="../static/dist/css/skins/_all-skins.min.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Google Font -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700,300italic,400italic,600italic">
    <link href="../src/css/scojs.css" rel="stylesheet">
    <link href="../src/css/colpick.css" rel="stylesheet">
    <link href="../src/css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" href="../src/css/main.css">
    <!--<link rel="stylesheet" href="../dist/css/danmuplayer.css">-->
</head>
<body class="hold-transition skin-blue sidebar-mini">

<header class="main-header">
    <a href="index.html" class="logo">
        <!-- LOGO -->
        Free
    </a>
    <!-- Header Navbar: style can be found in header.less -->
    <nav class="navbar navbar-static-top" role="navigation">
        <!-- Navbar Right Menu -->
        <div class="navbar-custom-menu">
            <ul class="nav navbar-nav">

                <li class="dropdown">
                    <form class="navbar-form navbar-right" role="search">
                        <div class="form-group">
                            <input type="search" autocomplete="true" class="form-control" id="navbar-search-input"
                                   placeholder="搜索内容">

                        </div>
                    </form>
                </li>

                <li class="dropdown user user-menu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        <img src="../static/dist/img/user2-160x160.jpg" class="user-image" alt="User Image">
                        <span class="hidden-xs">用户名</span>
                    </a>
                </li>
                <!-- Messages: style can be found in dropdown.less-->
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        <i class="fa fa-envelope-o"></i>
                        消息
                        <span class="label label-success">4</span>
                    </a>
                </li>
                <!-- Notifications: style can be found in dropdown.less -->
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        <i class="fa fa-bell-o"></i>
                        历史记录
                    </a>
                </li>

                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        <i class="fa  fa-power-off"></i>
                        退出
                    </a>
                </li>

            </ul>
        </div>
    </nav>
</header>

<section class="content">
    <div class="row col-md-offset-2">
        <div class="col-md-6">
            <!-- Box Comment -->
            <div class="box box-widget">
                <div class="box-header with-border">
                    <div class="user-block" id="userInfo">
                        <img class="img-circle" src="../static/dist/img/user1-128x128.jpg" alt="User Image">
                        <span class="username"><a href="#">用户名</a>
                            <button type="button" class="btn btn-default btn-xs"> 关注</button>
                        </span>

                        <span class="description">分区 2019-06-06 14:13:12</span>
                    </div>
                </div>
                <!-- /.box-header -->
                <div class="box-body">
                    <div id="danmup"></div>


                    <p>视频的简介</p>
                    <button type="button" class="btn btn-default btn-xs"><i class="fa fa-share"></i> Share</button>
                    <button type="button" class="btn btn-default btn-xs bg-blue"><i class="fa fa-thumbs-o-up"></i> Like</button>
                    <span class="pull-right text-muted">127 likes - 3 comments</span>
                </div>
                <!-- /.box-body -->


                <div class="box-footer box-comments" style="background-color: white" id="videoComment">

                    <div class="box-comment">
                        <!-- User image -->
                        <img class="img-circle img-sm" src="../static/dist/img/user3-128x128.jpg" alt="User Image">

                        <div class="comment-text">
                      <span class="username">
                        Maria Gonzales
                        <span class="text-muted pull-right">8:03 PM Today</span>
                      </span><!-- /.username -->
                            It is a long established fact that a reader will be distracted
                            by the readable content of a page when looking at its layout.
                        </div>
                        <!-- /.comment-text -->
                    </div>
                    <!-- /.box-comment -->
                    <div class="box-comment">

                            <!-- User image -->
                            <img class="img-circle img-sm" src="../static/dist/img/user4-128x128.jpg" alt="User Image">

                            <div class="comment-text">
                                 <span class="username">
                                  Luna Stark
                                   <span class="text-muted pull-right">8:03 PM Today</span>
                                 </span><!-- /.username -->
                                It is a long established fact that a reader will be distracted
                                by the readable content of a page when looking at its layout.
                                <button class="btn btn-success btn-xs pull-right">回复</button>
                                <a class="pull-right" data-toggle="collapse" href="#collapseThree">查看回复</a>
                            </div>

                            <div id="collapseThree" class="panel-collapse collapse">
                            </div>
                        <!-- /.comment-text -->
                    </div>
                    <!-- /.box-comment -->
                </div>
                <!-- /.box-footer -->
                <div class="box-footer" id="inputComment">

                </div>
                <!-- /.box-footer -->
            </div>
            <!-- /.box -->
        </div>
        <!-- /.col -->

        <div class="col-md-4 col-md-offset-1">
            <div class="box-header with-border">
                <div class="user-block">
                    <span class="username">相关推荐</span>
                    <span class="description">&nbsp;</span>
                </div>
            </div>
            <div class="box-body" id="sameVideo">
                <div class="info-box">
                    <div class="attachment-block clearfix">
                        <img class="attachment-img" src="../static/dist/img/photo1.png" alt="Attachment Image">

                        <div class="attachment-pushed">
                            <h4 class="attachment-heading"><a href="http://www.lipsum.com/">视频的简介</a></h4>

                            <div class="attachment-text">
                                上传者
                            </div>
                            <!-- /.attachment-text -->
                        </div>
                        <!-- /.attachment-pushed -->
                    </div>
                    <!-- /.info-box-content -->
                </div>
                <div class="info-box">
                    <div class="attachment-block clearfix">
                        <img class="attachment-img" src="../static/dist/img/photo1.png" alt="Attachment Image">

                        <div class="attachment-pushed">
                            <h4 class="attachment-heading"><a href="http://www.lipsum.com/">Lorem ipsum text
                                generator</a></h4>

                            <div class="attachment-text">
                                Description about the attachment can be placed here.
                                Lorem Ipsum is simply dummy text of the printing and typesetting industry... <a
                                    href="#">more</a>
                            </div>
                            <!-- /.attachment-text -->
                        </div>
                        <!-- /.attachment-pushed -->
                    </div>
                    <!-- /.info-box-content -->
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-sm-3">
            <div class="dataTables_info center-block" id="example2_info" role="status" aria-live="polite"></div>
        </div>
        <div class="col-sm-7">
            <div class="dataTables_paginate paging_simple_numbers" id="example2_paginate">
                <ul class="pagination" id="page">
                </ul>
            </div>
        </div>
    </div>


</section>

<!-- /.row -->


<!-- jQuery 3 -->
<script src="../static/bower_components/jquery/dist/jquery.min.js"></script>
<!-- Bootstrap 3.3.7 -->
<script src="../static/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>

<!--cookie-->
<script src="https://cdn.staticfile.org/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>

<script src="../src/js/jquery.shCircleLoader.js"></script>
<script src="../src/js/sco.tooltip.js"></script>
<script src="../src/js/colpick.js"></script>
<script src="../src/js/jquery.danmu.js"></script>
<script src="../src/js/main.js"></script>

<!-- Slimscroll -->
<script src="../static/bower_components/jquery-slimscroll/jquery.slimscroll.min.js"></script>
<!-- FastClick -->
<script src="../static/bower_components/fastclick/lib/fastclick.js"></script>
<!-- AdminLTE App -->
<script src="../static/dist/js/adminlte.min.js"></script>


<script src="../static/plugins/sweetalert/sweetalert.min.js"></script>

<script src="../static/tools.js"></script>

<script>

    var userId = $.cookie('userId');

    var videoId = getUrlParam("videoId");


    $(function () {
        getVideoInfo(videoId);
        updateVideovv();
    })



    function updateVideovv() {
        $.ajax({
            url:'/video/updateVideovv/'+videoId,
            type:'patch',
            success:function (data) {
                alert(data);
            }
        })
    }


    /**
     * 根据videoId获取video信息
     * @param videoId
     */
    function getVideoInfo(videoId) {
        $.ajax({
            url: '/video/getVideo',
            type: 'get',
            data: {
                id: videoId
            },
            success: function (data) {
                if (data.code == 0) {
                    var videoVo = data.data;
                    var video = videoVo.video;
                    var videoUserId = video.userId;
                    var focus = videoVo.focus;

                    showVideoAndBullet(video.videoSrc, video.id, video.typeId);
                    var flag = ifFocusExist(videoUserId)
                    showUserInfo(videoVo.userName, videoVo.icon, videoVo.type, video.upTime, focus, flag, videoUserId);
                    getVideoComment(video.id, 1, 1);
                    getTheSameVideo(videoUserId, video.typeId);
                }
            }

        })
    }


    //展示用户信息
    function showUserInfo(userName, icon, type, upTime, focus, flag, videoUserId) {
        $("#userInfo").empty();
        var appendhtml = '';
        appendhtml += '<img class="img-circle" src="..' + icon + '" alt="User Image">\n' +
            '                        <span class="username"><a href="#">' + userName + '</a>&nbsp;'+
            '                    <a href="/user/news.html?rId='+videoUserId+'" class="dropdown-toggle">\n' +
            '                        <i class="fa fa-envelope-o"></i>\n' +
            '                        发消息\n' +
            '                    </a>\n';
        if (flag) {
            appendhtml += '<div id="focus"><button type="button" class="btn btn-default btn-sm" onclick="delFocus(' + videoUserId + ')"> 取消关注' + focus + '</button></div>';
        } else {
            appendhtml += '<div id="focus"><button type="button" class="btn btn-info btn-sm" onclick="addFocus(' + videoUserId + ')"><span class="fa fa-fw fa-plus"></span>关注' + focus + '</button></div>'
        }
        appendhtml += '</span>\n' +
            '                        <span class="description">' + type + '&nbsp;&nbsp;&nbsp;&nbsp;' + upTime + '</span>';
        $("#userInfo").append(appendhtml);
    }


    //发送评论
    function sendVideoComment(videoId) {

        var content = $("#usercontent").val();
        $.ajax({
            url: '/videoComment/addComment',
            type: 'post',
            data: {
                userId: userId,
                type: 1,
                videoId: videoId,
                content: content
            },
            success: function (data) {
                if (data.code == 0) {
                    swal('', '评论成功！', 'success');
                    getVideoComment(videoId, 1, 1);
                }
            }
        });
    }


    /**
     * 根据视频的上传者的id和类型得到相似的视频信息
     * @param userId
     * @param type
     */
    function getTheSameVideo(userId, type) {
        $.ajax({
            url: '/video/getTheSameVideo',
            type: 'get',
            data: {
                userId: userId,
                type: type
            },
            success: function (data) {
                if (data.code == 0) {
                    var info = data.data;
                    showTheSameInfo(info);
                }
            }
        })
    }


    //展示相同类型的视频信息
    function showTheSameInfo(data) {
        var appendhtml = '';
        $("#sameVideo").empty();
        for (var i = 0; i < data.length; i++) {
            var video = data[i].video;
            console.log(video);
            var id = video.id;
            appendhtml += ' <div class="info-box">\n' +
                '                    <div class="attachment-block clearfix">\n' +
                '                        <img style="width: 100px;height:56px" class="attachment-img" src="..' + video.firstImagePath + '" alt="Attachment Image">\n' +
                '\n' +
                '                        <div class="attachment-pushed">\n' +
                '                            <h4 class="attachment-heading"><a href="/user/video.html?videoId=' + id + '">' + video.simpleIntroduce + '</a></h4>\n' +
                '\n' +
                '                            <span class="username">\n' +
                '                                ' + data[i].userName + '\n' +
                '                            </span>\n' +
                '                            <!-- /.attachment-text -->\n' +
                '                        </div>\n' +
                '                        <!-- /.attachment-pushed -->\n' +
                '                    </div>\n' +
                '                    <!-- /.info-box-content -->\n' +
                '                </div>';

        }
        $("#sameVideo").append(appendhtml);
    }


    /**
     * 播放视频和弹幕
     * @param src
     * @param videoId
     * @param type
     */
    function showVideoAndBullet(src, videoId, type) {
        $("#danmup").DanmuPlayer({
            src: ".." + src,
            width: "800px",
            height: "450px",
            urlToGetDanmu: "/bulletScreen/get?videoId=" + videoId + "&type=" + type,
            urlToPostDanmu: "/bulletScreen/add"
        });
    }

    /**
     * 得到视频的评论和回复
     * @param videoId
     * @param type 番剧或视频
     */
    function getVideoComment(videoId, type, currPage) {
        $.ajax({
            url: '/videoComment/getComment',
            type: 'get',
            data: {
                videoId: videoId,
                type: type,
                currPage: currPage
            },
            success: function (data) {
                if (data.code == 0) {
                    var data = data.data;
                    showVideoComment(data, videoId);
                }
            }
        })
    };


    /**
     * 显示视频的评论信息
     * @param data
     */
    function showVideoComment(data, videoId) {

        $("#videoComment").empty();

        var appendhtml = '';
        var lists = data.lists;
        for (var i = 0; i < lists.length; i++) {
            var videoComment = lists[i].videoComment;
            appendhtml += '<div class="box-comment" id="'+videoComment.id+'">\n' +
                '                        <!-- User image -->\n' +
                '                        <img class="img-circle img-sm" src="..' + lists[i].icon + '" alt="User Image">\n' +
                '\n' +
                '                        <div class="comment-text">\n' +
                '                      <span class="username">\n' +
                '                        ' + lists[i].userName + '\n' +
                '                        <i class="fa fa-thumbs-o-up pull-right">'+videoComment.praiseNumber+'</i>\n'+
                '                        <span class="text-muted pull-right">' + changeDateFormat(videoComment.createTime) + '</span>\n' +
                '                      </span><!-- /.username -->\n' +
                '                            ' + videoComment.content + '\n' +
                '                       <a class="" onclick="addCommentReplyInput('+videoComment.id+',\''+videoComment.content+'\','+videoComment.userId+')" style="cursor:pointer">回复</a>'+
                '                        <a class="pull-right" data-toggle="collapse" onclick="getCommentReply('+videoComment.id+')" href="#videoComment'+videoComment.id+'">查看回复</a>&nbsp;&nbsp;&nbsp;&nbsp;'+
                '                        </div>\n' +
                '                        <div id="videoComment'+videoComment.id+'" class="panel-collapse collapse">\n' +
                '                            </div>'+
                '                        <!-- /.comment-text -->\n' +
                '                    </div>';

        }
        $("#videoComment").append(appendhtml);
        getUserInfo(userId);
        commonPage(data, videoId, 1);
    }


    /**
     *获得当前登录用户的用户信息
     */
    function getUserInfo(userId) {
        var result;
        $.ajax({
            url: '/user/getUserInfo',
            type: 'get',
            data: {
                userId: userId
            },
            success: function (data) {
                if (data.code == 0) {
                    result = data.data;
                    showInput(result);
                }
            }
        });
    };

    /**
     * 展示评论输入框
     * @param data
     */
    function showInput(data) {
        $("#inputComment").empty();
        var appendInput = '<form action="#" method="post">\n' +
            '                        <img class="img-responsive img-circle img-sm" src="..' + data.icon + '"\n' +
            '                             alt="Alt Text">\n' +
            '                        <!-- .img-push is used to add margin to elements next to floating images -->\n' +
            '                        <div class="input-group margin">\n' +
            '                            <input id="usercontent" type="text" class="form-control input-sm" placeholder="说点什么吧">\n' +
            '                            <span class="input-group-btn">' +
            '                              <button type="button" class="btn btn-info btn-flat" onclick="sendVideoComment(' + videoId + ')">发送</button>' +
            '                            </span>' +
            '                        </div>\n' +
            '                    </form>';
        $("#inputComment").append(appendInput);
    }


    //得到评论下的回复
    function getCommentReply(commentId) {
        $.ajax({
            url:'/commentReply/get',
            type:'get',
            data:{
                commentId:commentId
            },
            success:function(data){
                var data=data.data;
                showCommentReply(data,commentId);
            }
        })
    }

    //展示评论下的回复
    function showCommentReply(data,id) {
        $("#videoComment"+id).empty();
        var appendhtml='';
        if(data.length==0){
            appendhtml+='无回复';
        }
        for (var i = 0; i < data.length; i++) {

            var commentReply=data[i].commentReply;
            appendhtml+='<div class="panel-body">';
            appendhtml += '<div class="box-comment">\n' +
                '                        <!-- User image -->\n' +
                '                        <img class="img-circle img-sm" src="..' + data[i].icon + '" alt="User Image">\n' +
                '\n' +
                '                        <div class="comment-text">\n' +
                '                      <span class="username">\n' +
                '                        ' + data[i].userName + '&nbsp;&nbsp;回复\n' +data[i].beUserName+
                '                        <span class="text-muted pull-right">' + changeDateFormat(commentReply.replyTime) + '</span>\n' +
                '                      </span><!-- /.username -->\n' +
                '                            ' + commentReply.content + '\n' +
                '                       <a class="" onclick="addCommentReplyInput('+commentReply.id+',\''+commentReply.content+'\','+data[i].userId+')" style="cursor:pointer">回复</a>'+
                '                        </div>\n' +
                '                        <!-- /.comment-text -->\n' +
                '                    </div>';
             appendhtml+='</div>';
        }
        $("#videoComment"+id).append(appendhtml);
    }

    
    function addComment() {
        
    }

    //对评论下的回复添加输入框
    function addCommentReplyInput(id,myContent,beReplyId) {
        var inputid='input'+id;
        var divinputid='divinput'+id;
        $("#"+divinputid).remove();
        var appendhtml='';
        appendhtml+='<div class="img-push" id="'+divinputid+'">\n' +
            '                  <input id="'+inputid+'" type="text" class="form-control input-sm" placeholder="说点什么吧">\n' +
            '                  <button onclick="sendCommentReply('+id+',\''+myContent+'\','+beReplyId+')">回复</button>'+
            '         </div>';
        $("#"+id).append(appendhtml);
    }

    /**
     * 给评论点赞
     * @param commentId
     */
    
    function giveCommentPraise(commentId) {
        var json = {"userId": videoUserId, "fansId": userId};
        $.ajax({
            url:'/videoComment/givePraise',
            type:'patch',
            data: JSON.stringify(json),
            contentType: 'application/json',
            success:function (data) {
                if(data.code==0){
                    if(data.data){

                    }
                }
            }

        })
    };
    

    /**
     * 给视频点赞
     *
     */

    function giveVideoPraise() {
        var json = {"userId": videoUserId, "fansId": userId};
        $.ajax({
            url:'/video/givePraise',
            type:'patch',
            data: JSON.stringify(json),
            contentType: 'application/json',
            success:function (data) {
                if(data.code==0){
                    if(data.data){

                    }

                }
            }

        })
    }


    /**
     * 分享视频
     */
    function giveVideoShare() {
        var json = {"userId": videoUserId, "fansId": userId};
        $.ajax({
            url:'/video/givePraise',
            type:'patch',
            data: JSON.stringify(json),
            contentType: 'application/json',
            success:function (data) {
                if(data.code==0){
                    if(data.data){

                    }

                }
            }

        })
    }


    /**
     * 收藏视频
     *
     */
    function giveVideoCollection() {
        var json = {"userId": videoUserId, "fansId": userId};
        $.ajax({
            url:'/video/givePraise',
            type:'patch',
            data: JSON.stringify(json),
            contentType: 'application/json',
            success:function (data) {
                if(data.code==0){
                    if(data.data){

                    }

                }
            }

        })
    }

    /**
     *发送回复消息
     */
    function sendCommentReply(id,myContent,beReplyId) {
        var content=$("#input"+id).val();
        $.ajax({
            url: '/commentReply/add',
            type: 'post',
            data: {
                content: content,
                replyId: userId,
                beReplyId: beReplyId,
                commentId: id,
                myContent: myContent
            },
            success: function (data) {
                if (data.code == 0) {
                    swal('', '回复成功', 'success');
                }
            }
        })
    }


    /**
     * 对上传视频者进行关注
     * @param videoUserId
     */
    function addFocus(videoUserId) {

        $.ajax({
            url: '/focus/addFocus',
            type: 'post',
            data: {
                userId: videoUserId,//视频上传者的id
                fansId: userId     //用户的id
            },
            success: function (data) {
                if (data.code == 0) {
                    var data = data.data;
                    if (data) {
                        swal('', '关注成功！', 'success');
                        var focus = getFocusNumber(videoUserId);
                        $("#focus").empty();
                        $("#focus").append('<button type="button" class="btn btn-default btn-sm" onclick="delFocus(' + videoUserId + ')"> 取消关注' + focus + '</button>');
                    }
                }
            }
        })
    }

    /**
     * 得到关注的数量
     */
    function getFocusNumber(userId) {
        var number;
        $.ajax({
            url: '/focus/getNumber',
            type: 'get',
            data: {
                userId: userId
            },
            async: false,
            success: function (data) {
                if (data.code == 0) {
                    number = data.data;
                }
            }
        });
        return number;
    }

    /**
     * 取消对某个用户的关注
     * @param videoUserId
     */
    function delFocus(videoUserId) {

        var json = {"userId": videoUserId, "fansId": userId};
        $.ajax({
            url: '/focus/delFocus',
            type: 'delete',
            data: JSON.stringify(json),
            contentType: 'application/json',
            success: function (data) {
                if (data.code == 0) {
                    var data = data.data;
                    if (data) {
                        var focus = getFocusNumber(videoUserId);
                        $("#focus").empty();
                        $("#focus").append('<button type="button" class="btn btn-info btn-sm" onclick="addFocus(' + videoUserId + ')"><span class="fa fa-fw fa-plus"></span>关注' + focus + '</button>');

                    }
                }
            }
        });

    }

    /**
     * 判断该用户是否已关注视频作者
     * @param videoUserId
     */
    function ifFocusExist(videoUserId) {
        var flag;
        $.ajax({
            url: '/focus/ifExist',
            type: 'get',
            async: false,
            data: {
                userId: videoUserId,//视频上传者的id
                fansId: userId     //用户的id
            },
            success: function (data) {
                if (data.code == 0) {
                    flag = data.data;

                }
            }
        });
        return flag;
    }
</script>
</body>
</html>